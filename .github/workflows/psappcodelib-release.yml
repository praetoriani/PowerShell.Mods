# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

# =============================================================================
# ENHANCED GITHUB ACTIONS WORKFLOW FOR PSAPPCORELIB RELEASES
# =============================================================================
# This file defines an automated workflow that can be triggered in two ways:
# 1. Automatically when a tag starting with "psacl-" is created (e.g. psacl-v1.0.1)
# 2. Manually through the GitHub Actions interface with custom parameters

name: PSAppCoreLib Release

# GLOBAL VARS
env:
  zip_filename: "PSAppCoreLib-Release.zip"      # Filename for the ZIP-Archive
  repo_folder: "PSAppCoreLib"                   # Name of the Folder inside the repository
  temp_folder: "PSAppCoreLib-Module"            # Folder-Name for the temporary folder
  workflow_file: "psappcorelib-release.yml"     # Filename for the ZIP-Archive

# TRIGGER CONFIGURATION - MULTIPLE TRIGGERS SUPPORTED
# Defines when this workflow should be executed
on:
  # AUTOMATIC TRIGGER: Tag-based execution
  push:
    tags:
      - 'psacl-*'   # Workflow starts only for tags beginning with "psacl-"
                    # Examples: psacl-v1.0.1, psacl-v2.0.0, psacl-beta-1

  # MANUAL TRIGGER: Allows running workflow from GitHub Actions interface
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for the release (e.g., psacl-v1.00.02)'
        required: true
        default: 'psacl-v1.00.00'
        type: string
      create_tag:
        description: 'Create the tag if it does not exist'
        required: true
        default: true
        type: boolean
      release_notes:
        description: 'Additional release notes (optional)'
        required: false
        default: ''
        type: string

# PERMISSIONS
# GitHub Actions requires explicit permission to create releases and tags
permissions:
  contents: write    # Allows creating and editing repository contents
  actions: write     # Allows workflow management

# JOB DEFINITION
# A workflow can contain multiple jobs, here we have only one
jobs:
  release:
    runs-on: ubuntu-latest    # The workflow runs on an Ubuntu Linux server
    
    # CONDITIONAL EXECUTION
    # Execute for psacl-tagged pushes OR manual dispatch
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/psacl-')) ||
      github.event_name == 'workflow_dispatch'
    
    # WORKFLOW STEPS
    # Each step is executed sequentially
    steps:
      # STEP 1: Download repository code
      # GitHub Actions runs on a fresh server and needs access to your code
      - name: Checkout repository
        uses: actions/checkout@v4    # Official GitHub Action for code download
        # After this step, all your repository files are available

      # STEP 2: Setup variables for different trigger types
      # Handle both automatic (tag push) and manual (workflow_dispatch) triggers
      - name: Setup release variables
        id: setup
        run: |
          # Determine tag name based on trigger type
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use user input
            TAG_NAME="${{ github.event.inputs.tag_name }}"
            echo "ğŸ”§ Manual trigger detected"
            echo "ğŸ“ Using tag: $TAG_NAME"
          else
            # Automatic trigger - use pushed tag
            TAG_NAME="${{ github.ref_name }}"
            echo "ğŸ·ï¸ Automatic tag trigger detected"
            echo "ğŸ“ Using tag: $TAG_NAME"
          fi
          
          # Validate tag format
          if [[ ! $TAG_NAME =~ ^psacl-.*$ ]]; then
            echo "âŒ Error: Tag name must start with 'psacl-'"
            echo "âŒ Provided: $TAG_NAME"
            exit 1
          fi
          
          # Export variables for later steps
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Tag validation successful: $TAG_NAME"

      # STEP 3: Create tag if manual trigger and tag doesn't exist
      # This step only runs for manual triggers when create_tag is enabled
      - name: Create tag if manual trigger
        if: |
          github.event_name == 'workflow_dispatch' && 
          github.event.inputs.create_tag == 'true'
        run: |
          TAG_NAME="${{ steps.setup.outputs.tag_name }}"
          
          # Configure Git with GitHub Actions bot identity
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Check if tag already exists
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "âš ï¸ Tag $TAG_NAME already exists"
            echo "â„¹ï¸ Continuing with existing tag..."
          else
            # Create and push new tag
            echo "ğŸ·ï¸ Creating new tag: $TAG_NAME"
            git tag "$TAG_NAME"
            git push origin "$TAG_NAME"
            echo "âœ… Tag created and pushed successfully"
          fi

      # STEP 4: Create release package
      # Only the PSAppCoreLib folder is packed into a ZIP package
      - name: Create PSAppCoreLib release package
        run: |
          # Debug output - displayed in the Actions log
          echo "ğŸš€ Starting release package creation for ${{ env.repo_folder }}"
          
          # Create temporary folder for the release
          mkdir -p release-temp/${{ env.temp_folder }}
          echo "ğŸ“ Temporary release folder created"
          
          # Verify source folder exists
          if [ ! -d "${{ env.repo_folder }}" ]; then
            echo "âŒ Error: '${{ env.repo_folder }}' folder not found!"
            echo "ğŸ“‚ Available folders:"
            ls -la
            exit 1
          fi
          
          # IMPORTANT: Copy all files from the ${{ env.repo_folder }} folder
          # Folder name contains spaces, therefore quotes are necessary
          cp -r "${{ env.repo_folder }}"/* release-temp/${{ env.temp_folder }}/
          echo "ğŸ“‹ ${{ env.repo_folder }} files copied:"
          ls -la "${{ env.repo_folder }}"/
          
          # Change to temporary folder
          cd release-temp
          
          # Create ZIP file with all ${{ env.repo_folder }} files
          # -r = recursive (include all subdirectories)
          zip -r ../${{ env.zip_filename }} ${{ env.temp_folder }}/
          
          # Return to root directory
          cd ..
          
          # Confirmation and display ZIP file size
          echo "âœ… ZIP file created:"
          ls -lh ${{ env.zip_filename }}
          
          # Verify ZIP file contents
          echo "ğŸ“¦ ZIP file contents:"
          unzip -l ${{ env.zip_filename }}

      # STEP 5: Create GitHub release with enhanced descriptions
      # This is the most important step - the actual release is created here
      - name: Create GitHub release with assets
        uses: softprops/action-gh-release@v1    # Proven third-party action for releases
        with:
          # DYNAMIC TAG NAME handling for both trigger types
          tag_name: ${{ steps.setup.outputs.tag_name }}
          
          # RELEASE TITLE
          # Uses the tag name (e.g. "PSAppCoreLib psacl-v1.0.1")
          name: PSAppCoreLib Module  ${{ steps.setup.outputs.tag_name }}
          
          # ENHANCED RELEASE DESCRIPTION (Markdown format supported)
          body: |
            ## ğŸ“‚ **File Download:**
            
            **ğŸ“¦ [`${{ env.zip_filename }}`](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.tag_name }}/${{ env.zip_filename }})**
            <br>
            
            ## âš ï¸ System Requirements:
            - Windows 10/11
            - PowerShell 5.1 or higher
            - Administrator privileges required
            <br>
            
            ${{ github.event.inputs.release_notes != '' && format('## ğŸ“ Additional Notes:\n{0}', github.event.inputs.release_notes) || '' }}
            
            ---
            *This release was automatically created by GitHub Actions.*
          
          # RELEASE SETTINGS
          files: ${{ env.zip_filename }}    # The ZIP file as download asset
          draft: false          # false = Release is published immediately
          prerelease: false     # false = Normal release (not marked as beta)
          
          # ERROR HANDLING
          fail_on_unmatched_files: true    # Workflow fails if ZIP file doesn't exist
          
        # AUTHENTICATION
        # GitHub Actions automatically uses GITHUB_TOKEN for authentication
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      # STEP 6: Confirm success with enhanced logging
      # Optional, but helpful for debugging and monitoring
      - name: Confirm release creation and provide usage instructions
        run: |
          TAG_NAME="${{ steps.setup.outputs.tag_name }}"
          TRIGGER_TYPE="${{ github.event_name }}"
          
          echo "ğŸ‰ ${{ github.workflow }} successfully created!"
          echo ""
          echo "ğŸ“Š Release Information:"
          echo "   ğŸ‘¤  Actor: ${{ github.actor }}"
          echo "   ğŸ·ï¸  Tag: $TAG_NAME"
          echo "   ğŸ”„  Trigger: $TRIGGER_TYPE"
          echo "   âš¡  Event-Type: ${{ github.event_name }}"
          echo "   ğŸ“  Repository: ${{ github.repository }}"
          echo "   ğŸ”—  Commit: ${{ github.sha }}"
          echo "   â°  Created: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ğŸŒ Release Links:"
          echo "   ğŸ“–  Release Page: https://github.com/${{ github.repository }}/releases/tag/$TAG_NAME"
          echo "   ğŸ’¾  Direct Download: https://github.com/${{ github.repository }}/releases/download/$TAG_NAME/${{ env.zip_filename }}"
          echo ""
          echo "ğŸš€ Next Steps for Users:"
          echo "   1. Visit the release page above"
          echo "   2. Download '${{ env.zip_filename }}'"
          echo ""
          echo "ğŸ”§ For Developers:"
          if [ "$TRIGGER_TYPE" = "workflow_dispatch" ]; then
            echo "   â€¢ This release was created manually via GitHub Actions"
            echo "   â€¢ To create another release, go to Actions â†’ ${{ github.workflow }} â†’ Run workflow"
          else
            echo "   â€¢ This release was created automatically by pushing tag: $TAG_NAME"
            echo "   â€¢ To create another release, push a new psacl-* tag or use manual trigger"
          fi
          echo "   â€¢ Manual trigger available at: https://github.com/${{ github.repository }}/actions/workflows/${{ env.workflow_file }}"